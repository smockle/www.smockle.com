<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><meta content name=author><meta name=supported-color-schemes content="light dark"><meta name=theme-color content="#26856d"><link rel=icon href=https://www.smockle.com/assets/images/favicon.png><link rel=apple-touch-icon href=https://www.smockle.com/assets/images/apple-touch-icon.png><title>Smockle Blog - Migrating from Travis CI to Docker Hub Automated Builds</title><meta property="og:title" content="Smockle Blog - Migrating from Travis CI to Docker Hub Automated Builds"><meta name=twitter:title content="Smockle Blog - Migrating from Travis CI to Docker Hub Automated Builds"><meta property="og:site_url" content="https://blog.smockle.com/2019/04/22/migrating-from-travis-ci-to-docker-hub-automated-builds/"><meta property="og:image" content="https://www.smockle.com/assets/images/og-image.png"><meta property="twitter:image" content="https://www.smockle.com/assets/images/twitter-image.png"><meta property="og:type" content="website"><meta name=twitter:card content="summary"><link href=/assets/css/style.css rel=stylesheet></head><body><div class=navigation><section id=wrapper><header class=h-card><a class=u-url href=/blog/><img id=avatar class="u-photo logo" src=https://www.smockle.com/assets/images/smockle.svg width=48 height=48></a></header></section></div><article class="h-entry post"><header><div class=dates><time class=dt-published datetime="2019-04-22 00:00:00 +0000">Apr 22, 2019</time></div><h1 class=p-name>Migrating from Travis CI to Docker Hub Automated Builds</h1></header><section class="e-content post-body"><p>Historically, I’ve used Travis CI to build and push new versions of my Docker images. In <a href=https://blog.smockle.com/2019/04/21/keeping-systems-up-to-date/>“Keeping systems up-to-date”</a>, I describe a feature missing from Travis CI that prompted me to try Docker Hub <a href=https://docs.docker.com/docker-hub/builds/>Automated Builds</a>:</p><blockquote><p>If you maintain Docker images, you’ll want to rebuild them when their base images are updated. This will produce a new image that includes security patches and bug fixes available in the base image. Docker Hub’s Automated Builds service supports this via a feature called “Repository Links”…</p></blockquote><p>The migration process was straightforward, with one complication—I build multi-architecture images using a <a href=https://docs.docker.com/engine/reference/commandline/manifest/>Docker image manifest</a>. This is not supported by the Docker Hub UI or by the version of Docker installed on the build infrastructure. But with <a href=https://docs.docker.com/docker-hub/builds/advanced/#custom-build-phase-hooks>“custom build phase hooks”</a>, I was able to build and push multi-architecture images successfully<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>.</p><p>First, I configured Automated Builds in the Docker Hub UI. I changed the value of “Build Tag” from <code>latest</code> to <code>build</code> and added set the “Environment Variable” <code>DOCKER_CLI_EXPERIMENTAL</code> to <code>enabled</code>:</p><p><img src=/uploads/2019/1fcf3ad186.jpg alt="Build settings"></p><p>Next, I added a directory named <code>hooks</code> to the root of my project. Inside <code>hooks</code>, I created four files—<code>pre_build</code>, <code>build</code>, <code>pre_push</code> and <code>post_push</code>.</p><p><code>docker-ee</code> version <code>17.x</code> is installed by default on Docker Hub build infrastructure. The <code>docker manifest</code> command was added in <code>docker-ee</code> version <code>18.x</code>. My <strong><code>pre_build</code></strong> hook updates <code>docker-ee</code> and <a href=https://hub.docker.com/r/multiarch/qemu-user-static/#binfmt_misc-register>prepares for multi-arch builds</a>:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#75715e>#!/bin/bash
</span><span style=color:#75715e></span>apt-get -y update
apt-get -y --only-upgrade install docker-ee
docker run <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  --rm <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  --privileged <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>multiarch/qemu-user-static:register --reset
</code></pre></div><p>My <strong><code>build</code></strong> hook builds and tags images for <code>armhf</code> and <code>amd64</code> processors. A <code>build</code> tag is also created, to support the “Build Tag” option set in the Docker Hub UI:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#75715e>#!/bin/bash
</span><span style=color:#75715e></span>docker build <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  --build-arg ARCH<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;armhf&#34;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  -t smockle/ddns53:arm <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  -f $DOCKERFILE_PATH .

docker build <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  --build-arg ARCH<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;amd64&#34;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  -t smockle/ddns53:amd64 <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  -t smockle/ddns53:$DOCKER_TAG <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  -f $DOCKERFILE_PATH .
</code></pre></div><p>My <strong><code>pre_push</code></strong> hook pushes the architecture-specific images:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#75715e>#!/bin/bash
</span><span style=color:#75715e></span>docker push smockle/ddns53:arm
docker push smockle/ddns53:amd64
</code></pre></div><p>The non-overridable <strong><code>push</code></strong> step pushes the <code>build</code> tag<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>. Finally, my <strong><code>post_push</code></strong> hook creates a Docker image manifest and publishes it as <code>latest</code>:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#75715e>#!/bin/bash
</span><span style=color:#75715e></span>docker manifest create <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  smockle/ddns53:latest <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  smockle/ddns53:amd64 <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  smockle/ddns53:arm

docker manifest annotate <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  smockle/ddns53:latest <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  smockle/ddns53:arm --os linux --arch arm

docker manifest annotate <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  smockle/ddns53:latest <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  smockle/ddns53:amd64 --os linux --arch amd64

docker manifest push --purge smockle/ddns53:latest
</code></pre></div><p>I committed and pushed the <code>hooks</code> directory. Back in the Docker Hub UI, I set “Repository Links” to “Enable for Base Image” to rebuild whenever my base image is updated:</p><p><img src=/uploads/2019/1fcf3ad186.jpg alt="Repository Links"></p><p>I clicked “Save and Build” and waited for the build to complete. After a few minutes, my build succeeded—making my migration from Travis CI to Docker Hub Automated Builds a success<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>.</p><section class=footnotes role=doc-endnotes><hr><ol><li id=fn:1 role=doc-endnote><p>For example, <a href=https://cloud.docker.com/u/smockle/repository/docker/smockle/ddns53>smockle/ddns53</a> <a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2 role=doc-endnote><p>The <code>build</code> tag is pointless, but if it is not created, the non-overridable <code>push</code> step will fail. You could set “Build Tag” to <code>amd64</code> in the UI and modify the hooks accordingly. I prefer not to split <code>docker push</code> commands. <a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3 role=doc-endnote><p>As an added bonus, READMEs displayed in the Docker Hub are now updated automatically. <a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></section></section></article><footer><div class=post-meta>© 2020 Clay Miller ~ Licensed under
<a rel=license href=http://creativecommons.org/licenses/by/4.0/legalcode>CC-BY-4.0</a> ~ <a href=/feed.xml>RSS</a></div></footer></body></html>